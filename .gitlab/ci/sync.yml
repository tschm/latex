sync:
  stage: sync
  #rules:
  #when: manual
  allow_failure: true #if you want the pipeline to continue even if this job isn't run

  needs: []
  variables:
    BRANCH_NAME: sync/update-configs
    COMMIT_MESSAGE: 'chore: sync config files from latex'
    REPO_URL: https://github.com/tschm/latex
    REPO_NAME: latex

  before_script:
    - apt-get update && apt-get install -y git curl unzip bash
  script:
    - |
      set -euo pipefail

      git config user.name "${GITLAB_USER_NAME:-GitLab CI}"
      git config user.email "${GITLAB_USER_EMAIL:-gitlab-ci@example.com}"
      git checkout -B "${BRANCH_NAME}" || git switch "${BRANCH_NAME}"

      # Download templates archive
      TEMP_DIR="$(mktemp -d)"
      trap 'rm -rf "$TEMP_DIR"' EXIT

      echo "ðŸ“¥ Downloading template archive..."
      git clone "${REPO_URL}" "$TEMP_DIR"
      
      ls -all "$TEMP_DIR"

      echo "ðŸ§¹ Removing files not needed for client..."
      rm -f "${TEMP_DIR}/action.yml"
      rm -f "${TEMP_DIR}/README.md"
      rm -f "${TEMP_DIR}/.gitignore"
      rm -f "${TEMP_DIR}/make_header.sh"
      rm -rf "${TEMP_DIR}/.github"
      rm -rf "${TEMP_DIR}/paper"
      rm -rf "${TEMP_DIR}/.git"

      echo "ðŸ“‚ Copying to working directory..."
      cp -Rf "${TEMP_DIR}/." .

      echo "âœ… Sync complete. Changed files:"
      git status --short || true

      # Commit and push if there are changes
      if [[ -n "$(git status --porcelain)" ]]; then
        git add .
        git commit -m "${COMMIT_MESSAGE}"
        git push "https://oauth2:${GITLAB_API_TOKEN}@gitlab.com/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}.git" "${BRANCH_NAME}" -o ci.skip

        # Create MR if token is set
        if [[ -n "${GITLAB_API_TOKEN:-}" ]]; then
          echo "Creating merge request..."
          curl --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
               --data "source_branch=${BRANCH_NAME}" \
               --data "target_branch=${CI_DEFAULT_BRANCH}" \
               --data "title=${COMMIT_MESSAGE}" \
               --data "description=This MR updates configuration files from the ${REPO_URL} repository." \
               --data "remove_source_branch=true" \
               "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests"
        else
          echo "GITLAB_API_TOKEN not set, skipping merge request creation"
          echo "Please create a merge request manually from branch ${BRANCH_NAME}"
        fi
      else
        echo "No changes detected, nothing to commit"
      fi