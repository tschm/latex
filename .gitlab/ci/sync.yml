sync:
  stage: sync
  image: debian:bookworm-slim
  rules:
    - when: manual
  allow_failure: true

  needs: []
  variables:
    COMMIT_MESSAGE: 'chore: sync files from latex'
    REPO_URL: https://github.com/tschm/latex
    REPO_NAME: latex

  before_script:
    - apt-get update && apt-get install -y git curl unzip bash

  script:
    - |
      set -euo pipefail

      git config user.name "${GITLAB_USER_NAME:-GitLab CI}"
      git config user.email "${GITLAB_USER_EMAIL:-gitlab-ci@example.com}"

      # Create a fresh random branch
      BRANCH="temp-$(date +%s)-$RANDOM"
      git checkout -b "$BRANCH"
      echo "✅ Created fresh branch: $BRANCH"

      # Pull latest changes to update the branch
      git pull --ff-only || true

      # Download repo A into temp dir
      TEMP_DIR="$(mktemp -d)"
      trap 'rm -rf "$TEMP_DIR"' EXIT
      git clone --depth 1 "${REPO_URL}" "$TEMP_DIR"

      # Remove files not needed
      rm -f "${TEMP_DIR}/action.yml" "${TEMP_DIR}/README.md" "${TEMP_DIR}/.gitignore"
      rm -rf "${TEMP_DIR}/.github" "${TEMP_DIR}/paper" "${TEMP_DIR}/.git"

      # Copy remaining files
      cp -Rf "${TEMP_DIR}/." .

      echo "✅ Sync complete. Changed files:"
      git status --short || true

      if [[ -n "$(git status --porcelain)" ]]; then
        git add .
        git commit -m "${COMMIT_MESSAGE}"
        git push "https://oauth2:${GITLAB_API_TOKEN}@gitlab.com/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}.git" "${BRANCH}" -o ci.skip

        if [[ -n "${GITLAB_API_TOKEN:-}" ]]; then
          echo "Creating merge request..."
          curl --silent --show-error --fail --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
               --data "source_branch=${BRANCH}" \
               --data "target_branch=${CI_DEFAULT_BRANCH}" \
               --data "title=${COMMIT_MESSAGE}" \
               --data "description=This MR updates configuration files from the ${REPO_URL} repository." \
               --data "remove_source_branch=true" \
               "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests"
        else
          echo "GITLAB_API_TOKEN not set; please create MR manually from branch ${BRANCH_NAME}"
        fi
      else
        echo "No changes detected; nothing to commit"
      fi
